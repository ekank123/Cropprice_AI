{% extends "base.html" %}

{% block title %}Home - Buffer Stock Prediction{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h1 class="text-center mb-4">Agricultural Buffer Stock Prediction</h1>
        <form id="predictionForm" method="POST" action="/predict">
            <div class="mb-3">
                <label for="csv_path" class="form-label">CSV Path</label>
                <input type="text" class="form-control" id="csv_path" name="csv_path" value="{{ csv_path }}">
            </div>
            <div class="mb-3">
                <label for="state" class="form-label">State</label>
                <select class="form-select" id="state" name="state" required>
                    <option value="">Select State</option>
                    {% for state in states %}
                    <option value="{{ state }}">{{ state }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="district" class="form-label">District</label>
                <select class="form-select" id="district" name="district" required disabled>
                    <option value="">Select District</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="market" class="form-label">Market</label>
                <select class="form-select" id="market" name="market" required disabled>
                    <option value="">Select Market</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="commodity" class="form-label">Commodity</label>
                <select class="form-select" id="commodity" name="commodity" required disabled>
                    <option value="">Select Commodity</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="variety" class="form-label">Variety</label>
                <select class="form-select" id="variety" name="variety" required disabled>
                    <option value="">Select Variety</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="days" class="form-label">Days to Forecast</label>
                <input type="number" class="form-control" id="days" name="days" min="1" value="4" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Predict</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stateSelect = document.getElementById('state');
    const districtSelect = document.getElementById('district');
    const marketSelect = document.getElementById('market');
    const commoditySelect = document.getElementById('commodity');
    const varietySelect = document.getElementById('variety');

    stateSelect.addEventListener('change', function() {
        const state = this.value;
        if (state) {
            fetch(`/get_districts/${state}`)
                .then(response => response.json())
                .then(data => {
                    districtSelect.innerHTML = '<option value="">Select District</option>';
                    data.forEach(district => {
                        districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
                    });
                    districtSelect.disabled = false;
                    resetSelects(marketSelect, commoditySelect, varietySelect);
                });
        } else {
            resetSelects(districtSelect, marketSelect, commoditySelect, varietySelect);
        }
    });

    districtSelect.addEventListener('change', function() {
        const state = stateSelect.value;
        const district = this.value;
        if (state && district) {
            fetch(`/get_markets/${state}/${district}`)
                .then(response => response.json())
                .then(data => {
                    marketSelect.innerHTML = '<option value="">Select Market</option>';
                    data.forEach(market => {
                        marketSelect.innerHTML += `<option value="${market}">${market}</option>`;
                    });
                    marketSelect.disabled = false;
                    resetSelects(commoditySelect, varietySelect);
                });
        } else {
            resetSelects(marketSelect, commoditySelect, varietySelect);
        }
    });

    marketSelect.addEventListener('change', function() {
        const state = stateSelect.value;
        const district = districtSelect.value;
        const market = this.value;
        if (state && district && market) {
            fetch(`/get_commodities/${state}/${district}/${market}`)
                .then(response => response.json())
                .then(data => {
                    commoditySelect.innerHTML = '<option value="">Select Commodity</option>';
                    data.forEach(commodity => {
                        commoditySelect.innerHTML += `<option value="${commodity}">${commodity}</option>`;
                    });
                    commoditySelect.disabled = false;
                    resetSelects(varietySelect);
                });
        } else {
            resetSelects(commoditySelect, varietySelect);
        }
    });

    commoditySelect.addEventListener('change', function() {
        const state = stateSelect.value;
        const district = districtSelect.value;
        const market = marketSelect.value;
        const commodity = this.value;
        if (state && district && market && commodity) {
            fetch(`/get_varieties/${state}/${district}/${market}/${commodity}`)
                .then(response => response.json())
                .then(data => {
                    varietySelect.innerHTML = '<option value="">Select Variety</option>';
                    data.forEach(variety => {
                        varietySelect.innerHTML += `<option value="${variety}">${variety}</option>`;
                    });
                    varietySelect.disabled = false;
                });
        } else {
            resetSelects(varietySelect);
        }
    });

    function resetSelects(...selects) {
        selects.forEach(select => {
            select.innerHTML = `<option value="">Select ${select.id.charAt(0).toUpperCase() + select.id.slice(1)}</option>`;
            select.disabled = true;
        });
    }
});
</script>
{% endblock %}